<div class="grid">
    <div class="col-12">
        <div class="text-2xl font-bold mb-4">DAR DE BAJA PERSONAL</div>
        <p-card header="Listado de Personal" styleClass="shadow-2">
            <div class="card">
                <p-table
                    #dt
                    [value]="trabajadores"
                    dataKey="id"
                    [rows]="10"
                    [loading]="loading"
                    [rowHover]="true"
                    [showGridlines]="true"
                    [paginator]="true"
                    [globalFilterFields]="['nombre', 'ci', 'empresa.nombre', 'estado']"
                    responsiveLayout="scroll"
                    selectionMode="multiple" 
                    [(selection)]="selectedTrabajadores"
                    rowGroupMode="subheader" 
                    groupRowsBy="empresa.nombre" 
                    sortMode="single" 
                    sortField="empresa.nombre" 
                >
                    <ng-template pTemplate="caption">
                        <div class="flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0 md:space-x-2">
                            <button pButton label="Limpiar Filtros" class="p-button-outlined" icon="pi pi-filter-slash" (click)="clear(dt)"></button>
                            <p-iconfield iconPosition="left" class="w-full md:w-auto md:ml-auto">
                                <p-inputicon>
                                    <i class="pi pi-search"></i>
                                </p-inputicon>
                                <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." class="w-full" />
                            </p-iconfield>
                            <button
                                pButton
                                label="Dar de Baja Seleccionados"
                                class="p-button-danger w-full md:w-auto"
                                icon="pi pi-minus-circle"
                                [disabled]="!selectedTrabajadores || selectedTrabajadores.length === 0"
                                (click)="irASolicitudes()"
                            ></button>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 4rem"><p-tableHeaderCheckbox></p-tableHeaderCheckbox></th>
                            <th style="min-width: 12rem">
                                <div class="flex justify-between items-center">
                                    Nombre
                                    <p-columnFilter type="text" field="nombre" display="menu" placeholder="Buscar por nombre"></p-columnFilter>
                                </div>
                            </th>
                            <th style="min-width: 12rem">
                                <div class="flex justify-between items-center">
                                    CI
                                    <p-columnFilter type="text" field="ci" display="menu" placeholder="Buscar por CI"></p-columnFilter>
                                </div>
                            </th>
                            <th style="min-width: 14rem">
                                <div class="flex justify-between items-center">
                                    Empresa
                                    <p-columnFilter type="text" field="empresa.nombre" display="menu" placeholder="Buscar por empresa"></p-columnFilter>
                                </div>
                            </th>
                            <th style="min-width: 10rem">
                                <div class="flex justify-between items-center">
                                    Fecha de Contrato
                                    <p-columnFilter type="date" field="fechaContrato" display="menu" placeholder="mm/dd/yyyy"></p-columnFilter>
                                </div>
                            </th>
                            <th style="min-width: 12rem">
                                <div class="flex justify-between items-center">
                                    Estado
                                    <p-columnFilter field="estado" matchMode="equals" display="menu">
                                        <ng-template #filter let-value let-filter="filterCallback">
                                            <p-selectButton
                                                [ngModel]="value"
                                                [options]="[{label: 'Activo', value: 'Activo'}, {label: 'Inactivo', value: 'Inactivo'}, {label: 'En Revisión', value: 'En Revisión'}]"
                                                (onChange)="filter($event.value)"
                                                optionLabel="label"
                                                optionValue="value"
                                            >
                                            </p-selectButton>
                                        </ng-template>
                                    </p-columnFilter>
                                </div>
                            </th>
                            <th *ngIf="isAdmin" style="width: 10rem">Acción</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="groupheader" let-trabajador>
                        <tr pRowGroupHeader>
                            <td colspan="7">
                                <div class="flex items-center gap-2">
                                    <img [alt]="trabajador.empresa.nombre" src="https://primefaces.org/cdn/primeng/images/demo/avatar/{{ trabajador.empresa.logo }}" width="32" style="vertical-align: middle" />
                                    <span class="font-bold">{{ trabajador.empresa.nombre }}</span>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-trabajador>
                        <tr>
                            <td><p-tableCheckbox [value]="trabajador"></p-tableCheckbox></td>
                            <td>{{ trabajador.nombre }}</td>
                            <td>{{ trabajador.ci }}</td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <img [alt]="trabajador.empresa.nombre" src="https://primefaces.org/cdn/primeng/images/demo/avatar/{{ trabajador.empresa.logo }}" width="32" style="vertical-align: middle" />
                                    <span>{{ trabajador.empresa.nombre }}</span>
                                </div>
                            </td>
                            <td>{{ trabajador.fechaContrato | date: 'dd/MM/yyyy' }}</td>
                            <td><p-tag [value]="trabajador.estado" [severity]="getSeverity(trabajador.estado)" /></td>
                            <td *ngIf="isAdmin">
                                <p-button
                                    icon="pi pi-trash"
                                    severity="danger"
                                    pTooltip="Dar de baja"
                                    tooltipPosition="bottom"
                                    (click)="darDeBaja(trabajador)">
                                </p-button>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="7">No se encontraron trabajadores.</td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="loadingbody">
                        <tr>
                            <td colspan="7">Cargando datos de trabajadores. Por favor espere.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
            
            <div *ngIf="!isAdmin" class="text-red-500 mt-4">
                No tienes permisos para dar de baja a un trabajador.
            </div>
        </p-card>
    </div>
</div>
<p-dialog 
    header="Confirmar Baja de Trabajador" 
    [(visible)]="mostrarDialogo" 
    [modal]="true" 
    [style]="{width: '90vw'}"
    [breakpoints]="{'960px': '75vw', '640px': '100vw'}"
    position="left">
    <div class="p-fluid">
        <p>Para confirmar la baja de **{{ trabajadorSeleccionado?.nombre }}**, por favor, ingresa tu contraseña de administrador.</p>
        <div class="p-field mt-4">
            <label for="password">Contraseña</label>
            <p-password [(ngModel)]="passwordConfirmacion" id="password" [toggleMask]="true" [feedback]="false"></p-password>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancelar" icon="pi pi-times" (click)="mostrarDialogo = false" severity="secondary"></p-button>
        <p-button label="Confirmar Baja" icon="pi pi-check" (click)="confirmarBaja()" severity="danger"></p-button>
    </ng-template>
</p-dialog>
<p-toast></p-toast>